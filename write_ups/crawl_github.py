#!/usr/bin/python
from bs4 import BeautifulSoup
import requests
import os
import sys
import markdown2
import webbrowser


#path=sys.argv[1]
path=os.curdir

category_list=["bonus", "crypto", "PPC", "recon", "steg", "exploit", "forensic", "pwn", "reverse", "network", "misc", "web"]

count = 0
list_of_content={}
r = requests.get('https://github.com/ctfs/write-ups')
soup = BeautifulSoup(r.text)
#li = soup.select('.js-directory-link')
#os.mkdir('/root/writeups/')
try:
	os.mkdir(path+'/writeups/')

	li_reg = soup.select('a[href^="/ctfs/write-ups-2014/tree/master/"]')#list of tags

	for i in range(0,len(li_reg)):
	    link = li_reg[i]['href']
	    print '*'*20
	    print '[',i+1,']', li_reg[i]['title'], link
	    print '-'*10

	    #challenges
	    b = requests.get('https://github.com'+ link)
	    soup2 = BeautifulSoup(b.text)
	    li_reg2 = soup2.select('a[href^="/ctfs/write-ups-2014/tree/master/"]')

	    for j in range(1,len(li_reg2)):
		challenge_writeup_link = li_reg2[j]['href']
		print '[',j,']', challenge_writeup_link
	
		sub_of_link = challenge_writeup_link.replace('/tree','')
		writeup_link = 'https://raw.githubusercontent.com'+ sub_of_link +'/README.md'
		print writeup_link
		c = requests.get(writeup_link)
		if c.status_code == 200:
		    res = c.content
		    #print res    
		    try:
			#file_name = res[res.index(':')+2:res.index('**')-2]
			file_name = sub_of_link[sub_of_link.rindex("/"):]
		    	category = res[res.find('Category')+12:res.find('**Points')-1]
			if len(category) > 20:
			    category = "other"
		    	points = res[res.find('Points')+10:res.find('**Description')-1]


		    except:
			file_name = res[res.index(':')+1:res.index('##')-2]
			#category = 'Other'
			for word in category_list:
			    for m in re.finditer(r'(?i)'+word, res):
				print(m.group(0))
				#category = m.group(0)
				category = word
				if word is not m.group(0):
				    category = "other"
				#print("start index:", m.start())		
			points = '0'
		    	
		    print "final print before saving",file_name, category, points
		    #content =[]

		    if category.find("'"):
			category = category.replace("'", "")
		    if category.find(","):
			category = category.replace(",", "")
		    if category.find(" "):
			category = category.replace(" ", "-")		    
		    list_of_content.setdefault(category, [])
		    list_of_content[category].append(file_name.replace("/", ""))
		    #list_of_content[category]= file_name
		    try:
		    	#os.mkdir('/root/writeups/'+category)
			 os.mkdir(path+'/writeups/'+category)
		    except:
			None
	
		    #f = open('/root/writeups/'+category+'/'+file_name+'.txt', 'w')
		    f = open(path+'/writeups/'+category+'/'+file_name+'.html', 'w')
		    f.write(markdown2.markdown(res).encode('utf-8'))
		    f.close()
		    count +=1

	print "\nThere are ", count, "writeups!!!!!!!!!! Enjoy ;)))))))"

	f = open(path +'/writeups/results.html','w')

	message = '''<html>
		     <head>
		     <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
		     </head><body>'''

	for key in list_of_content:
	    message += "<p><strong>"+ key + "</strong></p>"
	    for i in range(0, len(list_of_content[key])):
		#link = path+'/writeups/'+key+'/'+list_of_content[key][i]+'.html'
		link = path[:-2] + key+'/'+list_of_content[key][i]+'.html'
		message +="<li><a href=" +link+ ">" +list_of_content[key][i]+"</a></li>"
	        #message +="<li>"+ list_of_content[key][i] + "</li>"

	message +="</body></html>"
	f.write(message)
	f.close()

except:
	None

webbrowser.open_new_tab(path+'/writeups/results.html')
print path
